events {
    worker_connections 1024;
}

http {
    # Upstream para backend FastAPI
    # Por quê: Isola backend internamente, acessível apenas via proxy
    # Risco mitigado: Exposição direta do backend bloqueada
    upstream backend {
        server host.docker.internal:8000;
    }

    # Upstream para Grafana
    # Por quê: Grafana atrás do proxy para HTTPS
    # Risco mitigado: Acesso seguro sem alterar config interna do Grafana
    upstream grafana {
        server technoos_grafana:3000;
    }

    # HTTP Server (porta 80)
    # Por quê: Necessário para ACME HTTP-01 challenge e redirect
    # Risco mitigado: Apenas redirect, sem exposição de dados
    server {
        listen 80;
        server_name localhost;

        # ACME challenge location (para Let's Encrypt)
        location /.well-known/acme-challenge/ {
            proxy_pass http://backend;  # Ou servir static se necessário
        }

        # Redirect HTTP → HTTPS
        # Por quê: Força HTTPS para confidencialidade
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS Server (porta 443)
    # Por quê: TLS ativo para transporte seguro
    # Risco mitigado: MitM attacks, eavesdropping
    server {
        listen 443 ssl http2;
        server_name localhost;

        # Certificados self-signed para testes locais
        ssl_certificate /etc/nginx/certs/cert.pem;
        ssl_certificate_key /etc/nginx/certs/key.pem;

        # SSL Config (modern, segura)
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # Security Headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;

        # Proxy settings padrão
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # API routes (backend) - protegidas com Basic Auth
        # Por quê: Controle de acesso mínimo para superfície da API
        # Risco mitigado: Acesso não autorizado a endpoints sensíveis
        location / {
            auth_basic "Techno OS API";
            auth_basic_user_file /etc/nginx/.htpasswd;
            proxy_pass http://backend;
        }

        # Grafana (atrás do proxy)
        # Por quê: Dashboards acessíveis via HTTPS
        location /grafana/ {
            proxy_pass http://grafana/;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Uri /grafana;
        }

        # /metrics acessível para Prometheus (sem auth)
        # Por quê: Permite scrape contínuo
        # Risco mitigado: Exposição limitada a redes Docker (allowlist)
        location /metrics {
            allow 172.16.0.0/12;  # Docker networks
            deny all;
            proxy_pass http://backend;
        }

        # Health check público (para monitoring)
        # Por quê: Validação de disponibilidade
        location /health {
            proxy_pass http://backend;
        }
    }
}
